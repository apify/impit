name: "[impit-python] Release to PyPI"
permissions:
  contents: write
  id-token: write
'on':
  push:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Bump version'
        required: true
        type: choice
        default: 'patch'
        options:
          - 'major'
          - 'minor'
          - 'patch'

jobs:
    # test:
    #     name: Build and test
    #     uses: ./.github/workflows/python-test.yaml
    #     secrets: inherit

    publish:
        defaults:
          run:
            working-directory: impit-python
        name: Publish
        runs-on: ubuntu-latest
        # needs: [test]
        steps:
          - uses: actions/checkout@v4
            with:
              token: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}

          - name: Use Python
            uses: actions/setup-python@v5
            with:
              python-version: 3.x

          - name: Set up uv package manager
            uses: astral-sh/setup-uv@v5

          - name: Use Node.js
            uses: actions/setup-node@v4

          - name: Get current version
            id: get_version
            working-directory: impit-python
            run: |
              echo "current_version=$(uvx --from=toml-cli toml get --toml-path=pyproject.toml project.version)" >> "$GITHUB_OUTPUT"

          - name: Increment version
            id: increment_version
            working-directory: impit-python
            run: |
              echo "new_version=$(npx semver -i ${{ github.event.inputs.bump }} ${{ steps.get_version.outputs.current_version }})" >> "$GITHUB_OUTPUT"

          - name: Show new version
            id: show_new_version
            working-directory: impit-python
            run: |
              echo "New version is ${{ steps.increment_version.outputs.new_version }}"

          - name: Download all artifacts
            uses: actions/download-artifact@v4
            with:
              path: impit-python/dist
              run-id: 14217710491
              github-token: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}

          - name: List files
            run: |
                ls -la
                ls -la dist
